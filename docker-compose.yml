version: '3.2'
services:
  gmp-client:
    image: registry.gitlab.developers.cam.ac.uk/wh330/gmp-client
    command: sleep 3600
    depends_on:
      - "gvmd"

  gvm-postgres:
    build:
      context: ./gvm-postgres
    environment:
      - PGDATA=/var/lib/postgresql/data
      - POSTGRES_DB=gvmd
      - POSTGRES_PASSWORD=mypassword
      - POSTGRES_USER=gvmduser
    volumes:
      - postgres-data:/var/lib/postgresql/data

  gvmd:
    # CONNECTED /var/run/ospd/ospd.sock
    build:
      context: ./gvmd
    environment:
      - GVMD_POSTGRESQL_URI=postgresql://gvmduser:mypassword@gvm-postgres:5432/gvmd?application_name=gvmd
    volumes:
      - openvas-var-lib:/var/lib/openvas
      - gvm-var-lib:/var/lib/gvm
      - run-redis:/var/run/redis
      - run-ospd:/var/run/ospd
      - ./certs:/usr/var/lib/gvm
    depends_on:
      - "gvm-postgres"

  gsad:
    build:
      context: ./gsad
    ports:
      - 8080:80
    environment:
      - GVMD_HOST=gvmd
      - GVMD_PORT=9390
    depends_on:
      - "gvmd"

  openvas:
    # LISTENING /var/run/ospd/ospd.sock
    # CONNECTED /var/run/redis/redis.sock
    build:
      context: ./openvas
    privileged: true
    sysctls:
      net.core.somaxconn: '2048'
    volumes:
      - openvas-var-lib:/var/lib/openvas
      - run-redis:/var/run/redis
      - run-ospd:/var/run/ospd
    depends_on:
      - "gvm-postgres"

  openvas-1:
    # Additional openvas instance listening on TCP
    # CONNECTED /var/run/redis/redis.sock
    build:
      context: ./openvas
    command: ospd-openvas -l/dev/stdout -LINFO -p 9390 -b openvas-1 -k /run/secrets/key.pem -c /run/secrets/cert.pem --ca-file /run/secrets/cacert.pem -f
    privileged: true
    sysctls:
      net.core.somaxconn: '2048'
    volumes:
      - openvas-var-lib-1:/var/lib/openvas
      - run-redis:/var/run/redis
    secrets:
      - key.pem
      - cert.pem
      - cacert.pem
    depends_on:
      - "gvmd"
      - "gvm-postgres"

  # It is recommended to add vm.overcommit_memory=1 into
  # /etc/systcl.conf on the host
  redis:
    # LISTENING /var/run/redis/redis.sock
    image: redis:5.0
    volumes:
      - run-redis:/var/run/redis
      - redis-data:/data
    command: redis-server --port 0 --unixsocket /var/run/redis/redis.sock --unixsocketperm 755
    privileged: true
    sysctls:
      net.core.somaxconn: '2048'
    depends_on:
      - "openvas"

volumes:
  redis-data:
  openvas-var-lib:
  openvas-var-lib-1:
  gvm-var-lib:
  postgres-data:
  run-redis:
  run-ospd:

secrets:
  key.pem:
    file: certs/key.pem
  cert.pem:
    file: certs/cert.pem
  cacert.pem:
    file: certs/cacert.pem
